<?xml version="1.0"?>
<odoo>

    <record id="view_order_form_inherit_sale_stock" model="ir.ui.view">
        <field name="name">sale.order.form.sale.stock</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form" />
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_view_invoice']" position="before">
                <button type="object"
                    name="action_view_delivery"
                    class="oe_stat_button"
                    icon="fa-truck"
                    invisible="count_picking_ids == 0" groups="stock.group_stock_user">
                    <field name="count_picking_ids" widget="statinfo" string="Delivery" />
                </button>
            </xpath>
            <xpath expr="//group[@name='sale_shipping']" position="attributes">
                <attribute name="groups"></attribute><!-- Remove the res.group on the group and set
                it on the field directly-->
                <attribute name="string">Delivery</attribute>
            </xpath>
            <xpath expr="//label[@for='date_commitment']" position="before">
                <field name="warehouse_id" invisible="1" readonly="state == 'sale'" />  <!-- needed
                for js logic -->
                <field name="warehouse_id" options="{'no_create': True}" force_save="1"
                    readonly="state == 'sale'" />
                <field name="incoterm_id" options="{'no_open': True, 'no_create': True}" />
                <field name="incoterm_location" />
                <field name="picking_policy" required="True"
                    readonly="state != 'draft'" />
            </xpath>
            <xpath expr="//span[@name='date_planned_span']" position="attributes">
                <attribute name="invisible">date_effective and date_commitment</attribute>
            </xpath>
            <xpath expr="//div[@name='date_commitment_div']" position="replace">
                <div class="o_row">
                    <field name="date_commitment" />
                    <span class="text-muted" invisible="date_effective and date_commitment">Expected: <field name="date_planned" class="oe_inline"/></span>
                </div>
                <field name="date_effective" invisible="not date_effective" />
            </xpath>
            <field name="date_effective" position="after">
                <field name="transfer_state" invisible="state != 'sale'" />
            </field>
            <xpath expr="//page[@name='other_information']//field[@name='date_planned']" position="after">
                <field name="show_json_popover" invisible="1" />
                <field string=" " name="json_popover" widget="stock_rescheduling_popover"
                    invisible="not show_json_popover" />
            </xpath>
            <xpath expr="//field[@name='order_line_ids']/form/group/group/field[@name='analytic_distribution']" position="before">
                <field name="route_id" groups="stock.group_adv_location"
                    options="{'no_create': True}" />
            </xpath>
            <xpath expr="//field[@name='order_line_ids']/list/field[@name='analytic_distribution']" position="after">
                <field name="route_id" groups="stock.group_adv_location"
                    options="{'no_create': True}" optional="hide" />
            </xpath>
        </field>
    </record>

    <record id="sale_order_tree" model="ir.ui.view">
        <field name="name">sale.order.list.inherit.sale.stock</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.sale_order_tree" />
        <field name="arch" type="xml">
            <field name="tag_ids" position="after">
                <field name="warehouse_id"
                    options="{'no_create': True}"
                    groups="stock.group_stock_multi_warehouses"
                    optional="hide" readonly="state == 'sale'" />
            </field>
        </field>
    </record>

    <record id="view_order_tree" model="ir.ui.view">
        <field name="name">sale.order.list.inherit.sale.stock</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_tree" />
        <field name="arch" type="xml">
            <xpath expr="//field[@name='date_commitment']" position="attributes">
                <attribute name="decoration-danger">
                    (
                    (
                    date_commitment &lt; date_effective
                    or date_commitment &lt; datetime.datetime.combine(
                    datetime.date.today(),
                    datetime.time(0,0,0)
                    ).to_utc().strftime('%Y-%m-%d %H:%M:%S')
                    )
                    and transfer_state in ['to do', 'started']
                    and date_effective &lt;= date_commitment
                    or transfer_state == 'partially'
                    )
                </attribute>
            </xpath>
            <field name="invoice_state" position="before">
                <field name="date_effective" column_invisible="True" />
                <field name="transfer_state"
                    decoration-success="transfer_state == 'done'"
                    decoration-warning="transfer_state == 'partially'"
                    decoration-info="transfer_state in ['to do', 'started']"
                    widget="badge"
                    optional="hide" />
            </field>
        </field>
    </record>

    <record id="view_order_line_tree_inherit_sale_stock" model="ir.ui.view">
        <field name="name">sale.order.line.list.sale.stock.location</field>
        <field name="inherit_id" ref="sale.view_order_line_tree" />
        <field name="model">sale.order.line</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='price_subtotal']" position="before">
                <field name="route_id" groups="stock.group_adv_location"
                    options="{'no_create': True}" />
            </xpath>
        </field>
    </record>

    <record id="view_order_form_inherit_sale_stock_qty" model="ir.ui.view">
        <field name="name">sale.order.line.list.sale.stock.qty</field>
        <field name="inherit_id" ref="sale.view_order_form" />
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <xpath expr="//page/field[@name='order_line_ids']/form/group/group/div[@name='ordered_qty']/field[@name='product_uom_id']" position="after">
                <!-- below fields are used in the widget qty_at_date_widget -->
                <field name="qty_available_virtual_at_date" invisible="1" />
                <field name="qty_available_today" invisible="1" />
                <field name="qty_free_today" invisible="1" />
                <field name="date_planned" invisible="1" />
                <field name="date_planned_forecast" invisible="1" />
                <field name="warehouse_id" invisible="1" />
                <field name="move_ids" invisible="1" />
                <field name="qty_to_transfer" invisible="1" />
                <field name="is_mto" invisible="1" />
                <field name="display_qty_widget" invisible="1" />
                <widget name="qty_at_date_widget" />
            </xpath>
            <xpath expr="//page/field[@name='order_line_ids']/list/field[@name='qty_transfered']" position="after">
                <!-- below fields are used in the widget qty_at_date_widget -->
                <field name="qty_available_virtual_at_date" column_invisible="True" />
                <field name="qty_available_today" column_invisible="True" />
                <field name="qty_free_today" column_invisible="True" />
                <field name="date_planned" column_invisible="True" />
                <field name="date_planned_forecast" column_invisible="True" />
                <field name="warehouse_id" column_invisible="True" />
                <field name="move_ids" column_invisible="True" />
                <field name="qty_to_transfer" column_invisible="True" />
                <field name="is_mto" column_invisible="True" />
                <field name="display_qty_widget" column_invisible="True" />
                <widget name="qty_at_date_widget" width="20px" />
            </xpath>
        </field>
    </record>

</odoo>
