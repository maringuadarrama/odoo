<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="fleet_vehicle_view_search" model="ir.ui.view">
        <field name="name">fleet.vehicle.search</field>
        <field name="model">fleet.vehicle</field>
        <field name="arch" type="xml">
            <search string="All vehicles">
                <field name="name" string="Vehicle"
                    filter_domain="['|', ('name', 'ilike', self), ('license_plate', 'ilike', self)]" />
                <field name="model_id" string="Model" />
                <field name="license_plate" string="License Plate" />
                <field name="mobility_card"/>
                <field name="tag_ids" />
                <field name="vehicle_properties" string="Properties" />
                <filter name="available" string="Available"
                    domain="['&amp;', ('future_driver_id', '=', False), ('driver_id', '=', False)]" />
                <filter name="bikes" string="Bikes"
                    domain="[('vehicle_type', '=', 'bike')]" />
                <filter name="cars" string="Cars"
                    domain="[('vehicle_type', '=', 'car')]" />
                <filter name="trailer_hook" string="Trailer Hook"
                    domain="[('trailer_hook', '=', True)]" />
                <separator />
                <filter name="alert_true" string="Need Action"
                    domain="['|', ('contract_renewal_due_soon', '=', True), ('contract_renewal_overdue', '=', True)]" />
                <separator />
                <filter name="inactive" string="Archived"
                    domain="[('active', '=', False)]" />
                <separator />
                <filter name="activities_overdue" string="Late Activities" invisible="1"
                    domain="[('my_activity_date_deadline', '&lt;', context_today().strftime('%Y-%m-%d'))]"
                    help="Show all records which has next action date is before today" />
                <filter name="activities_today" string="Today Activities" invisible="1"
                    domain="[('my_activity_date_deadline', '=', context_today().strftime('%Y-%m-%d'))]" />
                <filter name="activities_upcoming_all" string="Future Activities" invisible="1"
                    domain="[('my_activity_date_deadline', '&gt;', context_today().strftime('%Y-%m-%d'))]" />
                <group string="Group By" expand="1">
                    <filter name="groupby_model" string="Model"
                        context="{'group_by': 'model_id'}" />
                    <filter name="groupby_make" string="Brand"
                        context="{'group_by': 'brand_id'}" />
                    <filter name="groupby_fueltype" string="Fuel Type"
                        context="{'group_by': 'fuel_type'}" />
                </group>
            </search>
        </field>
    </record>

    <record id='fleet_vehicle_view_tree' model='ir.ui.view'>
        <field name="name">fleet.vehicle.list</field>
        <field name="model">fleet.vehicle</field>
        <field name="arch" type="xml">
            <list string="Vehicle"
                multi_edit="1"
                sample="1"
                decoration-warning="contract_renewal_due_soon and not contract_renewal_overdue"
                decoration-danger="contract_renewal_overdue">
                <field name="active" column_invisible="True" />
                <field name="license_plate" readonly="1" />
                <field name="category_id" />
                <field name="model_id" widget="many2one_avatar" readonly="1" />
                <field name="driver_id" widget="many2one_avatar_user" readonly="1" optional="show" />
                <field name="future_driver_id" widget="many2one_avatar_user" readonly="1" optional="hide" />
                <field name="manager_id" widget="many2one_avatar_user" optional="hide" />
                <field name="odometer" readonly="1" optional="hide" />
                <field name="vin_sn" readonly="1" optional="hide" />
                <field name="engine_sn" readonly="1" optional="hide" />
                <field name="acquisition_date" readonly="1" />
                <field name="tag_ids" widget="many2many_tags"
                    readonly="1"
                    options="{'color_field': 'color'}" />
                <field name="contract_renewal_due_soon" invisible="1" />
                <field name="contract_renewal_overdue" invisible="1" />
                <field name="vehicle_properties" />
                <field name="contract_state" widget="badge"
                    decoration-info="contract_state == 'open'"
                    decoration-danger="contract_state == 'expired'"
                    optional="hide" />
                <field name="activity_exception_decoration" widget="activity_exception" />
            </list>
        </field>
    </record>

    <record id='fleet_vehicle_view_kanban' model='ir.ui.view'>
        <field name="name">fleet.vehicle.kanban</field>
        <field name="model">fleet.vehicle</field>
        <field name="arch" type="xml">
            <kanban sample="1">
                <field name="contract_renewal_due_soon" />
                <field name="contract_renewal_overdue" />
                <progressbar field="activity_state"
                    colors='{"planned": "success", "today": "warning", "overdue": "danger"}' />
                <templates>
                    <t t-name="card" class="flex-row">
                        <aside class="d-flex align-items-center me-2">
                            <field name="image_128" widget="image"
                                options="{'img_class': 'object-fit-cover'}" />
                        </aside>
                        <main>
                            <div>
                                <t t-if="record.license_plate.raw_value">
                                    <field class="fw-bolder fs-5" name="license_plate" />: </t>
                                <field class="fw-bolder fs-5" name="model_id" />
                            </div>
                            <field name="tag_ids" widget="many2many_tags"
                                options="{'color_field': 'color'}" />
                            <field t-if="record.driver_id.raw_value" name="driver_id"
                                widget="many2one_avatar" options="{'display_avatar_name': True}"
                                class="small pt-1 pb-1" />
                            <div class="small">
                                <t t-if="record.future_driver_id.raw_value">Future Driver : <field
                                        name="future_driver_id" /></t>
                            </div>
                            <t t-if="record.location.raw_value">
                                <small>
                                    <i class="fa fa-map-marker" title="Location"></i>
                                    <field name="location" />
                                </small>
                            </t>
                            <field name="vehicle_properties" widget="properties" />
                            <footer class="pt-0 mt-0" t-if="!selection_mode">
                                <div class="d-flex fs-6">
                                    <a t-if="record.contract_count.raw_value>0" type="object"
                                        name="return_action_to_open" href="#"
                                        data-context='{"xml_id":"action_fleet_vehicle_log_contract"}'>
                                        <field name="contract_count" /> Contract(s) <span
                                            t-if="record.contract_renewal_due_soon.raw_value and !record.contract_renewal_overdue.raw_value"
                                            class="fa fa-exclamation-triangle text-warning"
                                            role="img" aria-label="Warning: renewal due soon"
                                            title="Warning: renewal due soon">
                                        </span>
                                        <span
                                            t-if="record.contract_renewal_overdue.raw_value"
                                            class="fa fa-exclamation-triangle text-danger"
                                            role="img" aria-label="Attention: renewal overdue"
                                            title="Attention: renewal overdue">
                                        </span>
                                    </a>
                                    <field name="activity_ids" widget="kanban_activity" class="ms-2" />
                                </div>
                            </footer>
                        </main>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="fleet_vehicle_view_pivot" model="ir.ui.view">
        <field name="model">fleet.vehicle</field>
        <field name="arch" type="xml">
            <pivot>
                <field name="brand_id" type="row" />
                <field name="model_id" type="row" />
                <field name="license_plate" type="row" />
            </pivot>
        </field>
    </record>

    <record id='fleet_vehicle_view_form' model='ir.ui.view'>
        <field name="name">fleet.vehicle.form</field>
        <field name="model">fleet.vehicle</field>
        <field name="arch" type="xml">
            <form string="Vehicle" js_class="fleet_form">
                <field name="service_activity" invisible="1" />
                <header>
                    <button name="accept_driver_change" string="Apply New Driver"
                        type="object" class="btn btn-primary"
                        invisible="not future_driver_id" />
                </header>
                <sheet>
                    <field name="company_id" invisible="1" />
                    <field name="currency_id" invisible="1" />
                    <field name="country_code" invisible="1" />
                    <field name="active" invisible="1" />
                    <field name="vehicle_type" invisible="1" />
                    <div name="button_box" class="oe_button_box">
                        <button name="action_open_assignation_logs"
                            type="object" class="oe_stat_button"
                            icon="fa-history">
                            <field name="assignment_count" string="Drivers History" widget="statinfo" />
                        </button>
                        <button name="return_action_to_open"
                            type="object" class="oe_stat_button"
                            icon="fa-book"
                            context="{'xml_id':'action_fleet_vehicle_log_contract', 'search_default_inactive': not active}"
                            help="show the contract for this vehicle">
                            <field name="contract_count" string="Contracts" widget="statinfo" />
                        </button>
                        <button name="return_action_to_open"
                            type="object" class="oe_stat_button"
                            icon="fa-wrench"
                            context="{'xml_id':'action_fleet_vehicle_log_service', 'search_default_inactive': not active}"
                            invisible="service_activity != 'none'"
                            help="show the services logs for this vehicle">
                            <field name="service_count" string="Services" widget="statinfo" />
                        </button>
                        <button name="return_action_to_open"
                            type="object" class="oe_stat_button text-danger"
                            icon="fa-wrench"
                            context="{'xml_id':'action_fleet_vehicle_log_service', 'search_default_inactive': not active}"
                            invisible="service_activity != 'overdue'"
                            help="show the services logs for this vehicle">
                            <field name="service_count" string="Services" widget="statinfo" />
                        </button>
                        <button name="return_action_to_open"
                            type="object" class="oe_stat_button text-warning"
                            icon="fa-wrench"
                            context="{'xml_id':'action_fleet_vehicle_log_service', 'search_default_inactive': not active}"
                            invisible="service_activity != 'today'"
                            help="show the services logs for this vehicle">
                            <field name="service_count" string="Services" widget="statinfo" />
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Archived" bg_color="text-bg-danger"
                        invisible="active" />
                    <field name="image_128" widget='image' class="oe_avatar" />
                    <div name="title" class="oe_title">
                        <label for="name" />
                        <h1>
                            <field name="name" />
                        </h1>
                        <label for="model_id" />
                        <h2>
                            <field name="model_id" placeholder="e.g. Model S" />
                        </h2>
                        <label for="license_plate" />
                        <h2>
                            <field name="license_plate" class="oe_inline" placeholder="e.g. PAE 326" />
                        </h2>
                        <label for="tag_ids" />
                        <field name="tag_ids" widget="many2many_tags"
                            options="{'color_field': 'color', 'no_create_edit': True}" />
                    </div>
                    <group col="2">
                        <group string="Driver">
                            <field name="driver_id"
                                widget="many2one_avatar"
                                domain="['|', ('company_id', '=', False ), ('company_id', '=', company_id)]" />
                            <field name="future_driver_id" widget="many2one_avatar" />
                            <field name="manager_id"
                                widget="many2one_avatar_user"
                                domain="[('share', '=', False), ('company_id', '=', company_id)]" />
                            <field name="acquisition_date" invisible="vehicle_type != 'car'" />
                            <field name="write_off_date" invisible="vehicle_type != 'car'" />
                            <field name="next_assignation_date" />
                            <field name="company_id" groups="base.group_multi_company" />
                        </group>
                        <group string="Vehicle">
                            <field name="category_id" />
                            <field name="location" />
                            <field name="mobility_card" readonly="1"/>
                            <label for="odometer" invisible="vehicle_type != 'car'" />
                            <div invisible="vehicle_type != 'car'">
                                <field name="odometer" class="oe_inline" />
                                <span> in </span>
                                <field name="odometer_uom_id" class="oe_inline"
                                    options="{'no_create': True}" />
                            </div>
                        </group>
                    </group>
                    <field name="vehicle_properties" columns="2" />
                    <notebook>
                        <page name="page_model" string="Model">
                            <group>
                                <group name="group_model" string="Model">
                                    <field name="vin_sn" />
                                    <field name="model_year" />
                                    <field name="transmission"
                                        invisible="vehicle_type != 'car'" />
                                    <field name="color" />
                                    <field name="seats"
                                        invisible="vehicle_type != 'car'" />
                                    <field name="doors"
                                        invisible="vehicle_type != 'car'" />
                                    <field name="trailer_hook"
                                        invisible="vehicle_type != 'car'" />
                                    <field name="electric_assistance"
                                        invisible="vehicle_type != 'bike'" />
                                </group>
                                <group string="Engine" invisible="vehicle_type != 'car'">
                                    <field name="engine_sn" />
                                    <field name="power_unit" />
                                    <label for="power"
                                        invisible="power_unit != 'power'" />
                                    <div class="o_row"
                                        invisible="power_unit != 'power'">
                                        <field name="power" />
                                        <span>kW</span>
                                    </div>
                                    <field name="horsepower"
                                        invisible="power_unit != 'horsepower'" />
                                    <label for="vehicle_range" />
                                    <div class="o_row">
                                        <field name="vehicle_range" />
                                        <span>km</span>
                                    </div>
                                    <field name="fuel_type" />
                                    <label for="fuel_tank_capacity" />
                                    <div class="o_row">
                                        <field name="fuel_tank_capacity" /><span>L</span>
                                    </div>
                                    <field name="cilinders" />
                                    <label for="fuel_efficiency" />
                                    <div class="o_row">
                                        <field name="fuel_efficiency" /><span>km/L</span>
                                    </div>
                                    <label for="co2" />
                                    <div class="o_row" name="co2">
                                        <field name="co2" />
                                        <span>g/km</span>
                                    </div>
                                    <field name="co2_standard" />
                                </group>
                            </group>
                        </page>
                        <page name="page_contract_info" string="Contract Info">
                            <group>
                                <group string="Contract">
                                    <field name="first_contract_date" />
                                    <field name="car_value" widget="monetary" />
                                    <field name="net_car_value" widget="monetary" />
                                    <field name="residual_value" widget="monetary" />
                                </group>
                            </group>
                        </page>
                        <page name="page_tax_info" string="Tax Info">
                            <group>
                                <group col="1" name="fiscality_group" string="Fiscality">
                                    <group col="1" name="fiscality_first_group">
                                        <field name="horsepower_tax" widget="monetary" />
                                    </group>
                                </group>
                            </group>
                        </page>
                        <page name="note" string="Note">
                            <field name="description" nolabel="1"
                                placeholder="Write here any other information related to this vehicle" />
                        </page>
                    </notebook>
                </sheet>
                <chatter />
            </form>
        </field>
    </record>

    <record id="fleet_vehicle_view_activity" model="ir.ui.view">
        <field name="name">fleet.vehicle.activity</field>
        <field name="model">fleet.vehicle</field>
        <field name="arch" type="xml">
            <activity string="Vehicles">
                <field name="license_plate" />
                <field name="id" />
                <templates>
                    <div t-name="activity-box">
                        <img class="rounded-circle"
                            t-att-src="activity_image('fleet.vehicle', 'image_128', record.id.raw_value)"
                            role="img" t-att-title="record.id.value" t-att-alt="record.id.value" />
                        <div class="ms-2">
                            <field name="license_plate" display="full" class="o_text_block" />
                            <field name="model_id" muted="1" class="o_text_block" />
                        </div>
                    </div>
                </templates>
            </activity>
        </field>
    </record>

    <record id='fleet_vehicle_action' model='ir.actions.act_window'>
        <field name="name">Vehicles</field>
        <field name="path">fleet</field>
        <field name="res_model">fleet.vehicle</field>
        <field name="view_mode">list,kanban,form,pivot,activity</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Ready to manage your fleet more efficiently?
            </p>
            <p>
                Let's create your first vehicle.
            </p>
        </field>
    </record>

    <record id="action_fleet_vehicle_send_mail" model="ir.actions.server">
        <field name="name">Mail to Driver</field>
        <field name="model_id" ref="fleet.model_fleet_vehicle" />
        <field name="binding_model_id" ref="fleet.model_fleet_vehicle" />
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">action = records.action_send_email()</field>
    </record>
</odoo>
